<!-- <!DOCTYPE html> -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Hat Rider - Calculamatrise</title>
    <link rel="stylesheet" href="styles/default.css">
    <link rel="stylesheet" href="styles/dark.css" id="theme">
</head>
<body>
    <bhr-game-container>
        <canvas id="view"></canvas>
		<bhr-game-toolbar>
			<!-- <section class="bottom island right">
				<button class="toolbar-item fullscreen" title="Fullscreen - F" onclick="document.fullscreenElement ? document.exitFullscreen() : game.container.requestFullscreen()"></button>
			</section> -->
			<section class="bottom center island">
				<button class="toolbar-item rewind" title="Cancel Checkpoint - Backspace" onclick="game.scene.firstPlayer.removeCheckpoint()"></button>
				<button class="toolbar-item backtrack" title="Checkpoint - Enter" onclick="game.scene.firstPlayer.gotoCheckpoint()"></button>
				<label class="toolbar-item playpause" title="Pause/Play - Space"><input type="checkbox" style="display: none;" onchange="game.scene.paused = !this.checked" checked></label><!-- ▶ -->
				<button class="toolbar-item backtrack" title="Checkpoint - Shift + Enter" style="rotate: 180deg;" onclick="game.scene.firstPlayer.gotoCheckpoint()"></button>
				<button class="toolbar-item rewind" title="Cancel Checkpoint - Shift + Backspace" style="rotate: 180deg;" onclick="game.scene.firstPlayer.restoreCheckpoint()"></button>
			</section>
			<section class="center island top" id="recorder" style="display: none;/*visibility: hidden;*/">
				<!-- Display recording time -->
				<button id="toggle" title="Stop recording - Ctrl + Shift + R" onclick="game.mediaRecorder.addEventListener('stop', event => (this.parentElement.style.setProperty('display', 'none'), document.querySelector('#game-overlay').checked = true));game.mediaRecorder.stop()">Stop recording</button>
				<!-- <button class="toolbar-item recordstop" title="(Start/Stop??) Record - Ctrl + R" onclick="game.scene.removeCheckpoint()">🔴</button>
				<button class="toolbar-item" title="Stop recording - Backspace" onclick="game.scene.removeCheckpoint()">◾</button>◼ /◾ -->
			</section>
			<!-- Islands should grow when hovered -->
			<section class="island left middle">
				<label class="toolbar-item brush" title="Brush - A"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('brush', false)">●</label>
				<label class="toolbar-item scenery brush" title="Scenery Brush - S"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('brush', true)">●</label>
				<label class="toolbar-item line" title="Line - Q"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('line', false)" checked></label>
				<label class="toolbar-item scenery line" title="Scenery Line - W"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('line', true)"></label>
				<label class="toolbar-item powerups" title="Powerups"><input type="radio" name="tool" style="display: none;" onchange="powerups.querySelector('input[name=powerup]:checked').dispatchEvent(new Event('change'))">🗲</label>
				<label class="toolbar-item grid" title="Grid - G"><input type="checkbox" style="display: none;" onchange="game.scene.grid.size = 11 - game.scene.grid.size;"></label>
				<label class="toolbar-item eraser" title="Eraser - E"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('eraser')"></label>
				<button class="toolbar-item wheel" title="Change Vehicle - Ctrl + B" onclick="game.scene.switchBike()">
					<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25" style="stroke: #777;">
						<circle cx="12.5" cy="12.5" r="10"style="fill: none;stroke: var(--text-color);stroke-width: 2.5;" />
						<line x1="12.5" y1="12.5" x2="20.5" y2="12.5"/>
						<line x1="12.5" y1="12.5" x2="19.42820323027551" y2="16.5"/>
						<line x1="12.5" y1="12.5" x2="16.5" y2="19.428203230275507"/>
						<line x1="12.5" y1="12.5" x2="12.5" y2="20.5"/>
						<line x1="12.5" y1="12.5" x2="8.500000000000002" y2="19.42820323027551"/>
						<line x1="12.5" y1="12.5" x2="5.57179676972449" y2="16.5"/>
						<line x1="12.5" y1="12.5" x2="4.5" y2="12.500000000000002"/>
						<line x1="12.5" y1="12.5" x2="5.571796769724491" y2="8.5"/>
						<line x1="12.5" y1="12.5" x2="8.499999999999996" y2="5.571796769724492"/>
						<line x1="12.5" y1="12.5" x2="12.499999999999998" y2="4.5"/>
						<line x1="12.5" y1="12.5" x2="16.5" y2="5.571796769724491"/>
						<line x1="12.5" y1="12.5" x2="19.428203230275507" y2="8.499999999999996"/>
					</svg>
				</button>
				<label class="toolbar-item camera" title="Camera - R"><input type="radio" name="tool" style="display: none;" onchange="game.scene.toolHandler.setTool('camera')"></label>
			</section>
			<section class="island middle right">
				<div id="powerups" style="display: none;">
					<label class="toolbar-item powerup target" title="Goal"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('goal')" checked>●</label>
					<label class="toolbar-item powerup checkpoint" title="Checkpoint"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('checkpoint')">●</label>
					<label class="toolbar-item powerup triangle boost" title="Boost"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('boost')"></label><!-- ➠ -->
					<label class="toolbar-item powerup triangle gravity" title="Gravity"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('gravity')"></label>
					<label class="toolbar-item powerup bomb" title="Bomb"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('bomb')">●</label>
					<label class="toolbar-item powerup slowmo" title="Slow-motion"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('slow-mo')">●</label>
					<label class="toolbar-item powerup antigravity" title="Anti-gravity"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('antigravity')">●</label>
					<label class="toolbar-item powerup teleport" title="Teleporter"><input type="radio" name="powerup" style="display: none;" onchange="game.scene.toolHandler.setTool('teleporter')">●</label>
				</div>
				<div id="tool-settings">
					<button class="toolbar-item increment" title="Increase length - A + Scroll" onclick="game.scene.toolHandler.currentTool.scroll({ wheelDelta: 1 });">╋</button>
					<button class="toolbar-item decrement" title="Decrease length - A + Scroll" onclick="game.scene.toolHandler.currentTool.scroll({ wheelDelta: -1 });">▬</button>
					<div data-id="eraser" style="display: none;">
						<label class="toolbar-item brush" title="Erase physical lines - Enabled"><input type="checkbox" style="display: none;" onchange="game.scene.toolHandler.currentTool.ignoring[game.scene.toolHandler.currentTool.ignoring.has('physics') ? 'delete' : 'add']('physics');" checked>●</label>
						<label class="toolbar-item scenery brush" title="Erase visual lines - Enabled"><input type="checkbox" style="display: none;" onchange="game.scene.toolHandler.currentTool.ignoring[game.scene.toolHandler.currentTool.ignoring.has('scenery') ? 'delete' : 'add']('scenery');" checked>●</label>
						<label class="toolbar-item powerups" title="Erase powerups - Enabled"><input type="checkbox" style="display: none;" onchange="game.scene.toolHandler.currentTool.ignoring[game.scene.toolHandler.currentTool.ignoring.has('powerups') ? 'delete' : 'add']('powerups')" checked>🗲</label>
					</div>
					<button class="toolbar-item fullscreen" title="Fullscreen - F" onclick="document.fullscreenElement ? document.exitFullscreen() : game.container.requestFullscreen()"></button>
				</div>
				<!-- <button class="toolbar-item fullscreen" title="Fullscreen - F" onclick="document.fullscreenElement ? document.exitFullscreen() : game.container.requestFullscreen()"></button> -->
			</section>
			<!-- <input type="range" class="bottom timebar" style="left: 0;margin: 0;position: absolute;right: 0;"> -->
		</bhr-game-toolbar>
		<div class="bhr-game-overlay" style="display: none;">
			<input type="checkbox" id="game-overlay" style="display: none;">
			<nav>
				<!-- Track upload tab -->
				<label class="ripple" for="track">Track</label>
				<label class="ripple" for="ghost">Ghost</label>
				<label class="ripple" for="recorder-toggle">Recorder</label>
				<label class="ripple" for="settings">Settings</label>
			</nav>
			<section style="gap: 2px;">
				<input type="radio" name="bhr-game-overlay-nav" id="track" style="display: none;" checked>
				<div style="display: grid;grid-gap: .125rem;grid-template-columns: repeat(auto-fit, minmax(25vmin, 1fr));">
					<!-- Toggle move/edit mode button -->
					<label><input type="checkbox" onchange="game.scene.transformMode = event.target.checked;">Transform Mode</label>
					<button onclick="game.reset()" style="background-color: hsl(0deg 40% 40% / calc(50% + 10% * var(--brightness-multiplier)));">Clear</button>
					<button onclick="trackdialog.showModal()">Load</button>
					<button onclick="game.openFile({ multiple: event.ctrlKey })">Open File...</button>
					<!-- Open folder option allowing users to work on multiple tracks at once w/ different layers.
						This could help with "stop motion" tracks -->
					<button onclick="code.value = game.scene.toString();trackdialog.showModal();">Save</button>
					<button onclick="game.saveAs()">Save As...</button>
					<button onclick="game.showRecentFiles()">Show Recent Files</button>
					<button id="upload">Upload</button>
				</div>
				<!-- Display recently opened tracks -->
				<dialog class="bhr-dialog" id="trackdialog" onclose="event.target.returnValue == 'default' && (game.load(code.value),document.querySelector('#game-overlay').checked = false),code.value = null">
					<form method="dialog" style="margin: 0;">
						<textarea placeholder="Code" cols="30" rows="7" id="code" ondrop="Promise.all(Array.from(event.dataTransfer.items).filter(({ kind }) => kind === 'file').map(item => item.getAsFileSystemHandle())).then(fileHandles => game.loadFile({ fileHandles }));" onkeydown="event.stopPropagation()" onkeyup="event.stopPropagation()"></textarea>
						<!-- Show track size in textarea -->
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<button value="cancel" style="width: -webkit-fill-available;">Cancel</button>
							<button value="default" class="hidden-placeholder" style="width: -webkit-fill-available;">Load</button>
						</div>
					</form>
				</dialog>
				<dialog class="bhr-dialog" id="loadrecenttracks" onclose="event.target.returnValue != 'cancel' && (document.querySelector('#game-overlay').checked = false)">
					<form method="dialog" style="margin: 0;">
						<!-- Show last opened time + other metadata possibly in a table -->
						<div id="recenttracks" style="display: grid;"></div>
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<!-- <button>🗘</button> -->
							<button value="cancel" style="width: -webkit-fill-available;">Close</button>
						</div>
					</form>
				</dialog>
			</section>
			<section style="display: none;gap: 2px;">
				<input type="radio" name="bhr-game-overlay-nav" id="ghost" style="display: none;">
				<div style="display: grid;grid-gap: .125rem;grid-template-columns: repeat(auto-fit, minmax(25vmin, 1fr));">
					<button onclick="game.scene.ghosts.splice(0);" style="background-color: hsl(0deg 40% 40% / calc(50% + 10% * var(--brightness-multiplier)));">Clear</button>
					<button onclick="gcode.nextElementSibling.lastElementChild.style.setProperty('display', 'none');gcode.nextElementSibling.lastElementChild.previousElementSibling.style.removeProperty('display');ghostdialog.showModal();">Load</button>
					<button onclick="
						Object.assign(document.createElement('input'), {
							accept: 'text/plain',
							type: 'file',
							onchange: async event => {
								for (const file of event.target.files) {
									game.scene.watchGhost(await file.text());
								}
							}
						}).click();
					">Load File...</button>
					<button onclick="gcode.value = game.scene.firstPlayer.records.map(record => Array.from(record).join(' ')).join(',') + ',' + game.scene.firstPlayer.vehicle.name;gcode.nextElementSibling.lastElementChild.style.removeProperty('display');gcode.nextElementSibling.lastElementChild.previousElementSibling.style.setProperty('display', 'none');ghostdialog.showModal();">Save</button>
					<button onclick="
						Object.assign(document.createElement('a'), {
							download: 'bhr_ghost-' + new Intl.DateTimeFormat(navigator.language, { dateStyle: 'short', timeStyle: 'medium' }).format().replace(/[/:]/g, '-').replace(/,+\s*/, '_').replace(/\s+.*$/, ''),
							href: window.URL.createObjectURL(new Blob([gcode.value], { type: 'text/plain' }))
						}).click();
					">Save As...</button>
				</div>
				<dialog class="bhr-dialog" id="ghostdialog" onclose="event.target.returnValue == 'default' && (game.scene.watchGhost(gcode.value),document.querySelector('#game-overlay').checked = false),gcode.value = null">
					<form method="dialog" style="margin: 0;">
						<textarea placeholder="Ghost data" cols="30" rows="7" id="gcode" onkeydown="event.stopPropagation()" onkeyup="event.stopPropagation()"></textarea>
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<button value="cancel" style="width: -webkit-fill-available;">Cancel</button>
							<button value="default" class="hidden-placeholder" style="width: -webkit-fill-available;">Load</button>
							<button value="download" class="hidden-placeholder" onclick="
								Object.assign(document.createElement('a'), {
									download: 'bhr_ghost-' + new Intl.DateTimeFormat(navigator.language, { dateStyle: 'short', timeStyle: 'medium' }).format().replace(/[/:]/g, '-').replace(/,+\s*/, '_').replace(/\s+.*$/, ''),
									href: window.URL.createObjectURL(new Blob([gcode.value], { type: 'text/plain' }))
								}).click();
							" style="display: none;width: -webkit-fill-available;">Save As...</button>
						</div>
					</form>
				</dialog>
			</section>
			<section style="display: none;">
				<input type="radio" name="bhr-game-overlay-nav" id="recorder-toggle" style="display: none;">
				<button style="width: -webkit-fill-available;" onclick="game.createRecorder(blobURL => (download.href = blobURL) && loadrecording.showModal()).start(),recorder.style.removeProperty('display'),document.querySelector('#game-overlay').checked = false" onkeydown="event.stopPropagation()" onkeyup="event.stopPropagation()">Start Recorder</button>
				<label>FPS&emsp;<input type="number" min="10" max="300" step="10" value="50"></label>
				<button style="width: -webkit-fill-available;" disabled><a download="bhr_recording" id="adownload">Download</a></button>
				<dialog class="bhr-dialog" id="loadrecording">
					<form method="dialog" style="margin: 0;">
						<button style="width: -webkit-fill-available;"><a download="bhr_recording" id="download">Download</a></button>
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<button value="cancel" style="width: -webkit-fill-available;">Close</button>
						</div>
					</form>
				</dialog>
			</section>
			<section style="display: none;grid-gap: 1rem;margin: revert;margin-bottom: auto;">
				<input type="radio" name="bhr-game-overlay-nav" id="settings" style="display: none;">
				<!-- Add section for Discord RPC -->
				<section title="Editor" style="width: -webkit-fill-available;">
					<label>Auto save&emsp;<input type="checkbox" id="auto-save" onchange="game.settings.autoSave = event.target.checked;"></label>
				</section>
				<section title="Game" style="width: -webkit-fill-available;">
					<label>Auto pause&emsp;<input type="checkbox" id="auto-pause" onchange="game.settings.autoPause = event.target.checked;"></label>
				</section>
				<section title="Appearance" style="display: grid;grid-gap: .125rem;width: -webkit-fill-available;">
					<label><input type="radio" name="bhr-theme" id="dark" style="display: none;" onchange="game.settings.theme = event.target.id;">Dark</label>
					<label><input type="radio" name="bhr-theme" id="light" style="display: none;" onchange="game.settings.theme = event.target.id;">Light</label>
					<label><input type="radio" name="bhr-theme" id="midnight" style="display: none;" onchange="game.settings.theme = event.target.id;">Midnight</label>
				</section>
			</section>
			<button style="max-width: 25vmin;" onclick="window.close()">Exit to desktop ⍈</button>
		</div>
		<div class="toast-container" id="toasts"></div>
    </bhr-game-container>
    <script type="module" src="bootstrap.js"></script>
	<script type="module">
		const demo = await fetch('demo.txt').then(r => r.text());
		game.init({ code: demo, write: true });
		game.scene.on('load', async function() {
			const demoGhost = await fetch('demoghost.txt').then(r => r.text());
			this.watchGhost(demoGhost);
		});
		// game.init({ write: true });
	</script>
</body>
</html>