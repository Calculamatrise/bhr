<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Black Hat Rider - Calculamatrise</title>
        <link rel="stylesheet" href="styles/main.css">
        <link rel="stylesheet" href="styles/light.css" onload="
        localStorage.getItem('theme') === 'dark' && (this.href = 'styles/dark.css') || localStorage.getItem('theme') === 'midnight' && (this.href = 'styles/dark.css')
        ">
    </head>
    <body>
        <container>
            <interface>
                <overlay>
                    <nav onclick="event.target.tagName !== 'NAV' && ([...this.children].forEach(element => element.classList[event.target.dataset.id === element.dataset.id ? 'add' : 'remove']('active')),
                    document.querySelectorAll('options').forEach(element => element.style.setProperty('display', 'none')),
                    document.querySelector('options#' + event.target.dataset.id).style.setProperty('display',
                    document.querySelector('options#' + event.target.dataset.id).style.display === 'flex' ? 'none' : 'flex'))">
                        <button class="active" data-id="track">Track</button>
                        <button data-id="ghost">Ghost</button>
                        <button data-id="theme">Theme</button>
                    </nav>
                    <options id="track" style="display: flex;">
                        <button onclick="confirm('Are you sure you\'d like to clear the track?') && game.init()">Clear</button>
                        <button onclick="game.init(document.querySelector('textarea#code').value)">Load</button>
                        <button onclick="
                        let picker = document.createElement('input');
                        picker.type = 'file';
                        picker.accept = 'text/plain';
                        picker.addEventListener('change', function(event) {
                            const reader = new FileReader();
                            reader.addEventListener('load', function() {
                                game.init(this.result);
                            });
                            reader.readAsText(this.files[0]);
                        });
                        picker.click();
                        ">Load File...</button>
                        <button onclick="document.querySelector('textarea#code').value = game.track.toString()">Save</button>
                        <button onclick="
                        let date = new Date(new Date().setHours(new Date().getHours() - new Date().getTimezoneOffset() / 60)).toISOString().split(/t/i);
                        let link = document.createElement('a');
                        let file = new Blob([game.track.toString()], {
                            type: 'text/plain'
                        });
                        link.href = window.URL.createObjectURL(file);
                        link.download = 'bhr_track_' + date[0] + '_' + date[1].replace(/\..+/, '').replace(/:/g, '-');
                        link.click();
                        ">Save As...</button>
                        <textarea id="code" cols="30" rows="10"></textarea>
                    </options>
                    <options id="ghost">
                        <button onclick="game.track.players.splice(1, game.track.players.length)">Clear Ghosts</button>
                        <button onclick="game.track.watchGhost(document.querySelector('textarea#gcode').value)">Load</button>
                        <button onclick="
                        let picker = document.createElement('input');
                        picker.type = 'file';
                        picker.accept = 'text/plain';
                        picker.addEventListener('change', function(event) {
                            const reader = new FileReader();
                            reader.addEventListener('load', function() {
                                game.track.watchGhost(this.result);
                            });
                            reader.readAsText(this.files[0]);
                        });
                        picker.click();
                        ">Load File...</button>
                        <button onclick="document.querySelector('textarea#gcode').value = game.track.firstPlayer.gamepad.records.map(record => Object.keys(record).join(' ')).join(',')">Save</button>
                        <button onclick="
                        let date = new Date(new Date().setHours(new Date().getHours() - new Date().getTimezoneOffset() / 60)).toISOString().split(/t/i);
                        let link = document.createElement('a');
                        let file = new Blob([game.track.firstPlayer.gamepad.records.map(record => Object.keys(record).join(' ')).join(',')], {
                            type: 'text/plain'
                        });
                        link.href = window.URL.createObjectURL(file);
                        link.download = 'bhr_track_' + date[0] + '_' + date[1].replace(/\..+/, '').replace(/:/g, '-');
                        link.click();
                        ">Save As...</button>
                        <textarea id="gcode" cols="30" rows="10"></textarea>
                    </options>
                    <options id="theme">
                        <button onclick="localStorage.setItem('theme', 'light')">Light</button>
                        <button onclick="localStorage.setItem('theme', 'midnight')">Midnight</button>
                        <button onclick="localStorage.setItem('theme', 'dark')">Dark</button>
                    </options>
                </overlay>
                <toolbar>
                    <div class="left">
                        <tool title="Pause/Play - Space" onclick="this.firstElementChild.classList[(window.game.track.paused = !window.game.track.paused) ? 'remove' : 'add']('playing')">
                            <playpause class="playing"/>
                        </tool>
                        <tool title="Checkpoint - Enter" onclick="window.game.track.gotoCheckpoint()">
                            <backtrack/>
                        </tool>
                        <tool title="Cancel Checkpoint - Backspace" style="border-bottom-width: 1px;border-bottom-style: solid; border-bottom-right-radius: 5px;" onclick="window.game.track.removeCheckpoint()">
                            <rewind/>
                        </tool>
                        <br>
                        <tool title="Change Vehicle - Ctrl + B" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-right-radius: 5px;border-top-width: 1px;border-top-style: solid;border-top-right-radius: 5px;" tabindex="0" onclick="window.game.track.switchBike()">
                            <wheel>
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25">
                                    <circle cx="12.5" cy="12.5" r="10"/>
                                    <line x1="12.5" y1="12.5" x2="20.5" y2="12.5"/>
                                    <line x1="12.5" y1="12.5" x2="19.42820323027551" y2="16.5"/>
                                    <line x1="12.5" y1="12.5" x2="16.5" y2="19.428203230275507"/>
                                    <line x1="12.5" y1="12.5" x2="12.5" y2="20.5"/>
                                    <line x1="12.5" y1="12.5" x2="8.500000000000002" y2="19.42820323027551"/>
                                    <line x1="12.5" y1="12.5" x2="5.57179676972449" y2="16.5"/>
                                    <line x1="12.5" y1="12.5" x2="4.5" y2="12.500000000000002"/>
                                    <line x1="12.5" y1="12.5" x2="5.571796769724491" y2="8.5"/>
                                    <line x1="12.5" y1="12.5" x2="8.499999999999996" y2="5.571796769724492"/>
                                    <line x1="12.5" y1="12.5" x2="12.499999999999998" y2="4.5"/>
                                    <line x1="12.5" y1="12.5" x2="16.5" y2="5.571796769724491"/>
                                    <line x1="12.5" y1="12.5" x2="19.428203230275507" y2="8.499999999999996"/>
                                </svg>
                            </wheel>
                        </tool>
                        <br>
                        <tool title="Fullscreen - F" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-right-radius: 5px;border-top-width: 1px;border-top-style: solid;border-top-right-radius: 5px;" onclick="document.fullscreenElement ? (document.exitFullscreen(), this.firstElementChild.classList.remove('active')) : (window.game.container.requestFullscreen(), this.firstElementChild.classList.add('active'))">
                            <fullscreen/>
                        </tool>
                        <settings>
                            <tool title="Increase length - A + Scroll" style="border-top-width: 1px;border-top-style: solid;border-top-right-radius: 5px;" onclick="
                            if (window.game.track.toolHandler.selected === 'eraser') {
                                window.game.track.toolHandler.currentTool.size < 500 && (window.game.track.toolHandler.currentTool.size += 5);
                                return;
                            }

                            window.game.track.toolHandler.currentTool.length < 200 && (window.game.track.toolHandler.currentTool.length += 8);
                            ">
                                <increment/>
                            </tool>
                            <tool title="Decrease length - A + Scroll" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-right-radius: 5px;" onclick="
                            if (window.game.track.toolHandler.selected === 'eraser') {
                                window.game.track.toolHandler.currentTool.size > 10 && (window.game.track.toolHandler.currentTool.size -= 5);
                                return;
                            }

                            window.game.track.toolHandler.currentTool.length > 4 && (window.game.track.toolHandler.currentTool.length -= 8);
                            ">
                                <decrement/>
                            </tool>
                            <div data-id="eraser">
                                <tool title="Erase physical lines - Enabled" class="active" style="border-top-width: 1px;border-top-style: solid;border-top-right-radius: 5px;" onclick="
                                this.classList[(window.game.track.toolHandler.currentTool.settings.physics = !window.game.track.toolHandler.currentTool.settings.physics) ? 'add' : 'remove']('active');
                                ">
                                    <brush/>
                                </tool>
                                <tool title="Erase visual lines - Enabled" class="active" onclick="
                                this.classList[(window.game.track.toolHandler.currentTool.settings.scenery = !window.game.track.toolHandler.currentTool.settings.scenery) ? 'add' : 'remove']('active');
                                ">
                                    <brush class="scenery"/>
                                </tool>
                                <tool title="Erase powerups - Enabled" class="active" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-right-radius: 5px;" onclick="
                                this.classList[(window.game.track.toolHandler.currentTool.settings.powerups = !window.game.track.toolHandler.currentTool.settings.powerups) ? 'add' : 'remove']('active');
                                ">
                                    <powerup class="target"/>
                                </tool>
                            </div>
                        </settings>
                    </div>
                    <div class="right">
                        <tool title="Brush - A" onclick="window.game.track.toolHandler.setTool('brush'), window.game.track.toolHandler.currentTool.scenery = !1">
                            <brush/>
                        </tool>
                        <tool title="Scenery Brush - S" onclick="window.game.track.toolHandler.setTool('brush'), window.game.track.toolHandler.currentTool.scenery = !0">
                            <brush class="scenery"/>
                        </tool>
                        <tool title="Line - Q" onclick="window.game.track.toolHandler.setTool('line'), window.game.track.toolHandler.currentTool.scenery = !1">
                            <line>
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25">
                                    <line x1="20" y1="5" x2="5" y2="20"/>
                                </svg>
                            </line>
                        </tool>
                        <tool title="Scenery Line - W" onclick="window.game.track.toolHandler.setTool('line'), window.game.track.toolHandler.currentTool.scenery = !0">
                            <line class="scenery">
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25" style="stroke: #aaa">
                                    <line x1="20" y1="5" x2="5" y2="20"/>
                                </svg>
                            </line>
                        </tool>
                        <tool title="Eraser - E" onclick="window.game.track.toolHandler.setTool('eraser')">
                            <eraser/>
                        </tool>
                        <tool title="Camera - R" onclick="window.game.track.toolHandler.setTool('camera')">
                            <camera/>
                        </tool>
                        <tool title="Grid - G" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-left-radius: 5px;" onclick="
                        this.classList[(window.game.track.gridSize = 11 - window.game.track.gridSize) > 1 ? 'add' : 'remove']('active');
                        ">
                            <line class="scenery">
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25" style="stroke: #ccc; stroke-width: 1">
                                    <line x1="5" y1="5" x2="20" y2="5"/><line x1="5" y1="5" x2="5" y2="20"/>
                                    <line x1="5" y1="10" x2="20" y2="10"/><line x1="10" y1="5" x2="10" y2="20"/>
                                    <line x1="5" y1="15" x2="20" y2="15"/><line x1="15" y1="5" x2="15" y2="20"/>
                                    <line x1="5" y1="20" x2="20" y2="20"/><line x1="20" y1="5" x2="20" y2="20"/>
                                </svg>
                            </line>
                        </tool>
                        <br>
                        <tool title="Goal" style="border-top-width: 1px;border-top-style: solid;border-top-left-radius: 5px;" onclick="window.game.track.toolHandler.setTool('goal')">
                            <powerup class="target"/>
                        </tool>
                        <tool title="Checkpoint" onclick="window.game.track.toolHandler.setTool('checkpoint')">
                            <powerup class="checkpoint"/>
                        </tool>
                        <tool title="Booster" onclick="window.game.track.toolHandler.setTool('boost')">
                            <powerup class="boost triangle">
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25" style="stroke-width: 2">
                                    <polyline points="5,7 20,12.5 5,18 5,7"/>
                                </svg>
                            </powerup>
                        </tool>
                        <tool title="Gravity" onclick="window.game.track.toolHandler.setTool('gravity')">
                            <powerup class="gravity triangle">
                                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 25 25" style="stroke-width: 2">
                                    <polyline points="5,7 20,12.5 5,18 5,7"/>
                                </svg>
                            </powerup>
                        </tool>
                        <tool title="Bomb" onclick="window.game.track.toolHandler.setTool('bomb')">
                            <powerup class="bomb"/>
                        </tool>
                        <tool title="Slow-motion" onclick="window.game.track.toolHandler.setTool('slow-mo')">
                            <powerup class="slowmo"/>
                        </tool>
                        <tool title="Anti-gravity" onclick="window.game.track.toolHandler.setTool('antigravity')">
                            <powerup class="antigravity"/>
                        </tool>
                        <tool title="Teleporter" style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-left-radius: 5px;" onclick="window.game.track.toolHandler.setTool('teleporter')">
                            <powerup class="teleport"/>
                        </tool>
                    </div>
                </toolbar>
            </interface>
            <canvas id="view" width="800" height="450"></canvas>
        </container>
        <script type="module" src="bootstrap.js"></script>
        <script type="module">
            game.init();
            
            let e = e => e.stopPropagation();
            [...document.querySelectorAll("input"), ...document.querySelectorAll("textarea")].forEach(n => {
                n.addEventListener("keydown", e);
                n.addEventListener("keyup", e);
                n.addEventListener("keypress", e);
            });
        </script>
    </body>
</html>